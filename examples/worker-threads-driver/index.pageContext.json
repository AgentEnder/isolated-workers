{"pageId":"/pages/examples/@id","routeParams":{"id":"worker-threads-driver"},"data":{"example":{"id":"worker-threads-driver","path":"/home/runner/work/isolated-workers/isolated-workers/examples/worker-threads-driver","title":"Worker Threads Driver","description":"Use the worker_threads driver for in-process workers with shared memory support.\nWorker threads run in the same process as the host, enabling SharedArrayBuffer\nand lower overhead compared to child processes.\n","entryPoint":"host.ts","fileMap":"!undefined","commands":[{"command":"node --import tsx {filename}","title":"Run worker threads example","assertions":[{"contains":"Result:"},{"contains":"Worker threads driver"}]}],"hidden":false},"segments":[{"type":"html","html":"<h1>Worker Threads Driver</h1>\n<p>Use the worker_threads driver for in-process workers with shared memory support.\nWorker threads run in the same process as the host, enabling SharedArrayBuffer\nand lower overhead compared to child processes.</p>"}],"files":[{"filename":"messages.ts","content":"/**\n * Shared message definitions for the worker-threads-driver example\n */\n\nimport { DefineMessages } from 'isolated-workers';\n\n/**\n * Message types for the compute example\n */\nexport type Messages = DefineMessages<{\n  compute: {\n    payload: { value: number };\n    result: { result: number };\n  };\n}>;\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shared message definitions for the worker-threads-driver example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Message types for the compute example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> Messages</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a></span><span style=\"color:#E1E4E8\">&#x3C;{</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  compute</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">result</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}>;</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"host.ts","content":"/**\n * Worker Threads Driver Example - Host\n *\n * This example demonstrates using the worker_threads driver for in-process\n * workers. Worker threads share the same process as the host, enabling:\n * - Lower overhead for spawning\n * - SharedArrayBuffer support\n * - Faster message passing via MessagePort\n *\n * Note: Worker threads cannot outlive the parent process (no detach support)\n * and don't support reconnection.\n */\n\nimport { createWorker } from 'isolated-workers';\nimport { WorkerThreadsDriver } from 'isolated-workers/drivers/worker-threads';\nimport { fileURLToPath } from 'url';\nimport { dirname, join } from 'path';\nimport type { Messages } from './messages.js';\n\nasync function main() {\n  console.log('Using worker_threads driver for in-process workers\\n');\n\n  // WorkerThreadsDriver is a pre-configured object (not a class)\n  console.log(`Driver: ${WorkerThreadsDriver.name}`);\n  console.log(`Capabilities:`);\n  console.log(`  - Reconnect: ${WorkerThreadsDriver.capabilities.reconnect}`);\n  console.log(`  - Detach: ${WorkerThreadsDriver.capabilities.detach}`);\n  console.log(`  - Shared Memory: ${WorkerThreadsDriver.capabilities.sharedMemory}`);\n  console.log();\n\n  // Create the worker using the worker_threads driver\n  const workerPath = join(dirname(fileURLToPath(import.meta.url)), 'worker.ts');\n\n  try {\n    // Specify the driver in the options\n    // The createWorker function will use it instead of the default child_process driver\n    // Worker threads automatically inherit the host's execArgv (e.g., --import tsx)\n    const worker = await createWorker<Messages, typeof WorkerThreadsDriver>({\n      script: workerPath,\n      driver: WorkerThreadsDriver,\n      logLevel: 'info',\n    });\n\n    console.log(`Worker spawned (pid: ${worker.pid ?? 'N/A - same process'})`);\n    console.log(`Worker capabilities: reconnect=${worker.capabilities.reconnect}, sharedMemory=${worker.capabilities.sharedMemory}`);\n\n    // Send a compute request\n    console.log('\\nSending compute request...');\n    const response = await worker.send('compute', { value: 42 });\n    console.log(`Result: ${response.result}`);\n\n    // Note: disconnect/reconnect are not available with worker_threads\n    // worker.disconnect() would be a type error because capabilities.reconnect is false!\n\n    // Clean up\n    await worker.close();\n    console.log('\\nWorker threads driver example complete!');\n  } catch (err) {\n    console.error('Error:', (err as Error).message);\n    process.exit(1);\n  }\n}\n\nmain();\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Worker Threads Driver Example - Host</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This example demonstrates using the worker_threads driver for in-process</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * workers. Worker threads share the same process as the host, enabling:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Lower overhead for spawning</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - SharedArrayBuffer support</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Faster message passing via MessagePort</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Note: Worker threads cannot outlive the parent process (no detach support)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * and don't support reconnection.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers/drivers/worker-threads'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { fileURLToPath } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'url'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { dirname, join } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'path'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Using worker_threads driver for in-process workers</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // WorkerThreadsDriver is a pre-configured object (not a class)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`<a href=\"/isolated-workers/api/driver\" class=\"code-link\">Driver</a>: ${</span><span style=\"color:#E1E4E8\"><a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a></span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">name</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Capabilities:`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Reconnect: ${</span><span style=\"color:#E1E4E8\"><a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a></span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">capabilities</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">reconnect</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Detach: ${</span><span style=\"color:#E1E4E8\"><a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a></span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">capabilities</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">detach</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Shared Memory: ${</span><span style=\"color:#E1E4E8\"><a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a></span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">capabilities</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">sharedMemory</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Create the worker using the worker_threads driver</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> workerPath</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> join</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">dirname</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">fileURLToPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">meta</span><span style=\"color:#E1E4E8\">.url)), </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Specify the driver in the options</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // The createWorker function will use it instead of the default child_process driver</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Worker threads automatically inherit the host's execArgv (e.g., --import tsx)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">typeof</span><span style=\"color:#E1E4E8\"> <a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a>>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: workerPath,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      driver: <a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      logLevel: </span><span style=\"color:#9ECBFF\">'info'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker spawned (pid: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#F97583\"> ??</span><span style=\"color:#9ECBFF\"> 'N/A - same process'})`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker capabilities: reconnect=${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">capabilities</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">reconnect</span><span style=\"color:#9ECBFF\">}, sharedMemory=${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">capabilities</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">sharedMemory</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Send a compute request</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">Sending compute request...'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> response</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, { value: </span><span style=\"color:#79B8FF\">42</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Result: ${</span><span style=\"color:#E1E4E8\">response</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">result</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Note: disconnect/reconnect are not available with worker_threads</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // worker.disconnect() would be a type error because capabilities.reconnect is false!</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Clean up</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">Worker threads driver example complete!'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"worker.ts","content":"/**\n * Worker Threads Driver Example - Worker\n *\n * This worker runs in a worker thread (same process as host).\n * Since the host spawned this worker using WorkerThreadsDriver,\n * we must specify the same driver here for the server.\n */\n\nimport { startWorkerServer, type Handlers } from 'isolated-workers';\nimport { WorkerThreadsDriver } from 'isolated-workers/drivers/worker-threads';\nimport type { Messages } from './messages.js';\n\n// Define handlers\nconst handlers: Handlers<Messages> = {\n  compute: async ({ value }) => {\n    console.log(`[Worker] Computing ${value} * 2...`);\n\n    // Simulate some work\n    await new Promise((resolve) => setTimeout(resolve, 100));\n\n    return { result: value * 2 };\n  },\n};\n\n// Start the worker server\n// Must specify WorkerThreadsDriver to match the host\nstartWorkerServer<Messages>(handlers, {\n  driver: WorkerThreadsDriver,\n  logLevel: 'info',\n}).then(() => {\n  console.log('[Worker] Server started');\n}).catch((err) => {\n  console.error('[Worker] Failed to start server:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Worker Threads Driver Example - Worker</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This worker runs in a worker thread (same process as host).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Since the host spawned this worker using WorkerThreadsDriver,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * we must specify the same driver here for the server.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a>, </span><span style=\"color:#F97583\">type</span><span style=\"color:#E1E4E8\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers/drivers/worker-threads'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Define handlers</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  compute</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> ({ </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`[Worker] Computing ${</span><span style=\"color:#E1E4E8\">value</span><span style=\"color:#9ECBFF\">} * 2...`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Simulate some work</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#F97583\"> new</span><span style=\"color:#79B8FF\"> Promise</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">resolve</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> setTimeout</span><span style=\"color:#E1E4E8\">(resolve, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { result: value </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Start the worker server</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Must specify WorkerThreadsDriver to match the host</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\"><a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>(handlers, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  driver: <a href=\"/isolated-workers/api/worker-threads-driver\" class=\"code-link\">WorkerThreadsDriver</a>,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  logLevel: </span><span style=\"color:#9ECBFF\">'info'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}).</span><span style=\"color:#B392F0\">then</span><span style=\"color:#E1E4E8\">(() </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'[Worker] Server started'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}).</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'[Worker] Failed to start server:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"}],"renderedFiles":[]}}