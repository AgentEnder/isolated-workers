{"pageId":"/pages/examples/@id","routeParams":{"id":"shutdown-handling"},"data":{"example":{"id":"shutdown-handling","path":"/home/runner/work/isolated-workers/isolated-workers/examples/shutdown-handling","title":"Unexpected Worker Shutdown Handling","description":"Demonstrates how to handle unexpected worker crashes with configurable\nretry strategies, per-message-type overrides, and detailed error context.\n","entryPoint":"host.ts","fileMap":{"./messages.ts":"messages.ts","./host.ts":"host.ts","./worker.ts":"worker.ts"},"commands":[{"command":"pnpm run:shutdown-handling","title":"Run the example","assertions":[{"contains":"Test 1: Normal operation"},{"contains":"Result: 25"},{"contains":"Test 2: Idempotent operation with crash - retry exhaustion"},{"contains":"WorkerCrashedError after retries"},{"contains":"Attempt: 3/3"},{"contains":"Test 3: Non-idempotent operation"},{"contains":"Attempt: 1/1"},{"contains":"No retries"},{"contains":"Test 4: Batch processing with retry exhaustion"},{"contains":"Test 5: Successful batch processing"},{"contains":"Processed batch of 3 items"}]}],"hidden":false},"segments":[{"type":"html","html":"<h1>Unexpected Worker Shutdown Handling</h1>\n<p>This example demonstrates how to handle unexpected worker crashes with configurable strategies and detailed error context.</p>\n<h2>Overview</h2>\n<p>When a worker process dies unexpectedly (OOM crash, SIGKILL, or hard crash), pending requests may be left in limbo. The shutdown handling feature provides:</p>\n<ul>\n<li><strong>Reliable crash detection</strong> via exit events (works even for OOM kills)</li>\n<li><strong>Configurable strategies</strong>: Reject immediately or retry automatically</li>\n<li><strong>Per-message-type overrides</strong>: Different strategies for different operations</li>\n<li><strong>Rich error context</strong>: <code class=\"inline-code\"><a class=\"code-link\" href=\"/isolated-workers/isolated-workers/api/worker-crashed-error\">WorkerCrashedError</a></code> with crash details and attempt counts</li>\n</ul>\n<h2>When to Use Each Strategy</h2>\n<h3>Reject Strategy (<code class=\"inline-code\">strategy: 'reject'</code>)</h3>\n<p>Use for <strong>non-idempotent operations</strong> where retrying could cause side effects:</p>\n<ul>\n<li>Payment processing</li>\n<li>Database writes</li>\n<li>External API calls that aren't safe to replay</li>\n</ul>\n<pre><code class=\"language-typescript\">unexpectedShutdown: {\n  strategy: 'reject',  // default behavior\n  processPayment: { strategy: 'reject' },\n}\n</code></pre>\n<h3>Retry Strategy (<code class=\"inline-code\">strategy: 'retry'</code>)</h3>\n<p>Use for <strong>idempotent operations</strong> that can be safely retried:</p>\n<ul>\n<li>Read-only queries</li>\n<li>Computations</li>\n<li>Data processing tasks</li>\n</ul>\n<pre><code class=\"language-typescript\">unexpectedShutdown: {\n  strategy: 'reject',\n  compute: { strategy: 'retry', attempts: 2 },  // retry up to 2 times\n  fetchData: { strategy: 'retry' },  // uses default 1 attempt\n}\n</code></pre>\n<h2>Files</h2>\n<h3>Shared Message Definitions</h3>\n<p>Define message types that both host and worker import:</p>"},{"type":"file","filename":"messages.ts","language":"typescript","content":"/**\n * Shared message definitions for the shutdown-handling example\n *\n * This file is imported by both the host and worker to ensure\n * type safety and avoid duplication.\n */\n\nimport { DefineMessages } from 'isolated-workers';\n\n/**\n * Message types demonstrating different shutdown scenarios\n */\nexport type Messages = DefineMessages<{\n  // Idempotent operation - safe to retry\n  compute: {\n    payload: { value: number; shouldCrash?: boolean };\n    result: { result: number };\n  };\n\n  // Non-idempotent operation - should reject on crash\n  processPayment: {\n    payload: { paymentId: string; amount: number; shouldCrash?: boolean };\n    result: { success: boolean };\n  };\n\n  // Operation that may fail - demonstrate retry limits\n  processBatch: {\n    payload: { items: number[]; crashAfterItems?: number };\n    result: { processed: number };\n  };\n}>;\n","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shared message definitions for the shutdown-handling example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This file is imported by both the host and worker to ensure</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * type safety and avoid duplication.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\" title=\"View DefineMessages documentation\">DefineMessages</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Message types demonstrating different shutdown scenarios</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> Messages</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\" title=\"View DefineMessages documentation\">DefineMessages</a></span><span style=\"color:#E1E4E8\">&#x3C;{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Idempotent operation - safe to retry</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  compute</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">result</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Non-idempotent operation - should reject on crash</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  processPayment</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">paymentId</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">amount</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">success</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Operation that may fail - demonstrate retry limits</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  processBatch</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">items</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">[]; </span><span style=\"color:#FFAB70\">crashAfterItems</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">processed</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}>;</span></span>\n<span class=\"line\"></span></code></pre>"},{"type":"html","html":"<h3>Host (Client)</h3>\n<p>Demonstrates different shutdown strategies and error handling:</p>"},{"type":"file","filename":"host.ts","language":"typescript","content":"/**\n * Shutdown Handling Example - Host (Client) Side\n *\n * Demonstrates different strategies for handling unexpected worker crashes:\n * - 'reject' strategy: Immediately reject pending requests\n * - 'retry' strategy: Automatically retry failed requests\n * - Per-message-type overrides: Different strategies for different operations\n */\n\nimport { createWorker, WorkerCrashedError } from 'isolated-workers';\nimport { fileURLToPath } from 'url';\nimport { dirname, join } from 'path';\nimport type { Messages } from './messages.js';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nasync function createTestWorker() {\n  return createWorker<Messages>({\n    script: join(__dirname, 'worker.ts'),\n    timeout: 10000,\n    unexpectedShutdown: {\n      strategy: 'reject', // default for all messages\n      compute: { strategy: 'retry', attempts: 3 }, // retry idempotent ops up to 3 times\n      processBatch: { strategy: 'retry', attempts: 3 }, // retry with limit\n      // processPayment uses default 'reject' - non-idempotent\n    },\n  });\n}\n\nasync function main() {\n  console.log('=== Shutdown Handling Example ===\\n');\n\n  let worker = await createTestWorker();\n  console.log(`Worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 1: Normal operation (no crash)\n  console.log('Test 1: Normal operation');\n  try {\n    const result = await worker.send('compute', { value: 5 });\n    console.log('✓ Result:', result.result, '\\n');\n  } catch (err) {\n    console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n  }\n\n  // Test 2: Idempotent operation with crash (retry will also crash - demonstrates exhaustion)\n  // Note: When a worker crashes, the retry spawns a NEW worker process.\n  // If the crash condition is in the payload (shouldCrash: true), retries will also crash.\n  // This demonstrates retry exhaustion for idempotent operations.\n  console.log('Test 2: Idempotent operation with crash - retry exhaustion');\n  try {\n    const result = await worker.send('compute', {\n      value: 7,\n      shouldCrash: true, // Will crash on every attempt\n    });\n    console.log('✗ Should have crashed, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError after retries:', err.message);\n      console.log(`  - Reason: ${err.reason.type}`);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need a fresh worker since Test 2 exhausted retries\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 3: Non-idempotent operation (should reject immediately, no retry)\n  console.log('Test 3: Non-idempotent operation (should reject, not retry)');\n  try {\n    // This payment will crash, and since processPayment uses 'reject' strategy,\n    // it should fail with WorkerCrashedError immediately (no retries)\n    const result = await worker.send('processPayment', {\n      paymentId: 'pay-123',\n      amount: 100,\n      shouldCrash: true,\n    });\n    console.log('✗ Payment should have been rejected, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError (as expected):', err.message);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}`);\n      console.log(`  - No retries (non-idempotent operation)\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need a fresh worker since Test 3 crashed\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 4: Batch processing with retry exhaustion\n  console.log('Test 4: Batch processing with retry exhaustion');\n  try {\n    // This batch will crash immediately (crashAfterItems: 0), and will keep crashing\n    // until we exhaust all 3 retry attempts\n    const result = await worker.send('processBatch', {\n      items: [1, 2, 3, 4, 5],\n      crashAfterItems: 0, // Crash immediately every time\n    });\n    console.log('✗ Should have exhausted retries, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError after retries:', err.message);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need another fresh worker since Test 4 exhausted retries\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 5: Successful batch processing (no crash)\n  console.log('Test 5: Successful batch processing');\n  try {\n    const result = await worker.send('processBatch', {\n      items: [1, 2, 3],\n      // No crashAfterItems = no crash\n    });\n    console.log('✓ Processed batch of', result.processed, 'items\\n');\n  } catch (err) {\n    console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n  }\n\n  // Test 6: Cleanup\n  console.log('Test 6: Cleanup');\n  await worker.close();\n  console.log('✓ Worker closed successfully\\n');\n\n  console.log('=== All tests completed ===');\n}\n\nmain().catch((err) => {\n  console.error('Host error:', err);\n  process.exit(1);\n});\n","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shutdown Handling Example - Host (Client) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Demonstrates different strategies for handling unexpected worker crashes:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - 'reject' strategy: Immediately reject pending requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - 'retry' strategy: Automatically retry failed requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Per-message-type overrides: Different strategies for different operations</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a>, <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { fileURLToPath } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'url'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { dirname, join } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'path'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> __dirname</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> dirname</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">fileURLToPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">meta</span><span style=\"color:#E1E4E8\">.url));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    script: </span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(__dirname, </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeout: </span><span style=\"color:#79B8FF\">10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    unexpectedShutdown: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      strategy: </span><span style=\"color:#9ECBFF\">'reject'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// default for all messages</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      compute: { strategy: </span><span style=\"color:#9ECBFF\">'retry'</span><span style=\"color:#E1E4E8\">, attempts: </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\"> }, </span><span style=\"color:#6A737D\">// retry idempotent ops up to 3 times</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      processBatch: { strategy: </span><span style=\"color:#9ECBFF\">'retry'</span><span style=\"color:#E1E4E8\">, attempts: </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\"> }, </span><span style=\"color:#6A737D\">// retry with limit</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // processPayment uses default 'reject' - non-idempotent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'=== Shutdown Handling Example ===</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  let</span><span style=\"color:#E1E4E8\"> worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 1: Normal operation (no crash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 1: Normal operation'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, { value: </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Result:'</span><span style=\"color:#E1E4E8\">, result.result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 2: Idempotent operation with crash (retry will also crash - demonstrates exhaustion)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Note: When a worker crashes, the retry spawns a NEW worker process.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // If the crash condition is in the payload (shouldCrash: true), retries will also crash.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // This demonstrates retry exhaustion for idempotent operations.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 2: Idempotent operation with crash - retry exhaustion'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      value: </span><span style=\"color:#79B8FF\">7</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      shouldCrash: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Will crash on every attempt</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Should have crashed, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a> after retries:'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Reason: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">reason</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need a fresh worker since Test 2 exhausted retries</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 3: Non-idempotent operation (should reject immediately, no retry)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 3: Non-idempotent operation (should reject, not retry)'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This payment will crash, and since processPayment uses 'reject' strategy,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // it should fail with <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a> immediately (no retries)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processPayment'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      paymentId: </span><span style=\"color:#9ECBFF\">'pay-123'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      amount: </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      shouldCrash: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Payment should have been rejected, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a> (as expected):'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - No retries (non-idempotent operation)</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need a fresh worker since Test 3 crashed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 4: Batch processing with retry exhaustion</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 4: Batch processing with retry exhaustion'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This batch will crash immediately (crashAfterItems: 0), and will keep crashing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // until we exhaust all 3 retry attempts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processBatch'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      items: [</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      crashAfterItems: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Crash immediately every time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Should have exhausted retries, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\" title=\"View WorkerCrashedError documentation\">WorkerCrashedError</a> after retries:'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need another fresh worker since Test 4 exhausted retries</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 5: Successful batch processing (no crash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 5: Successful batch processing'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processBatch'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      items: [</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // No crashAfterItems = no crash</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Processed batch of'</span><span style=\"color:#E1E4E8\">, result.processed, </span><span style=\"color:#9ECBFF\">'items</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 6: Cleanup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 6: Cleanup'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Worker closed successfully</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'=== All tests completed ==='</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Host error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"},{"type":"html","html":"<h3>Worker</h3>\n<p>Worker that processes requests and can crash on specific commands:</p>"},{"type":"file","filename":"worker.ts","language":"typescript","content":"/**\n * Shutdown Handling Example - Worker (Server) Side\n *\n * This worker demonstrates various scenarios including:\n * - Normal message processing\n * - Crashing during processing (for retry testing)\n * - Processing that takes time\n */\n\nimport { startWorkerServer, Handlers } from 'isolated-workers';\nimport type { Messages } from './messages.js';\n\nconst handlers: Handlers<Messages> = {\n  compute: ({ value, shouldCrash = false }) => {\n    console.log(`Worker: computing ${value}^2 (shouldCrash=${shouldCrash})`);\n\n    if (shouldCrash) {\n      console.log('Worker: crashing as requested');\n      process.exit(1);\n    }\n\n    return { result: value * value };\n  },\n\n  processPayment: ({ paymentId, amount, shouldCrash = false }) => {\n    console.log(`Worker: processing payment ${paymentId} for $${amount}`);\n\n    if (shouldCrash) {\n      console.log('Worker: crashing during payment processing');\n      process.exit(1);\n    }\n\n    return { success: true };\n  },\n\n  processBatch: ({ items, crashAfterItems }) => {\n    console.log(`Worker: processing batch of ${items.length} items`);\n\n    if (crashAfterItems !== undefined && crashAfterItems >= 0) {\n      console.log(\n        `Worker: will crash after processing ${crashAfterItems} items`\n      );\n      // Process up to the crash point, then crash\n      for (let i = 0; i < Math.min(crashAfterItems, items.length); i++) {\n        // Simulate processing\n        items[i] * 2;\n      }\n      console.log('Worker: crashing as requested');\n      process.exit(1);\n    }\n\n    return { processed: items.length };\n  },\n};\n\nasync function main() {\n  console.log('Worker starting...');\n  console.log(`Worker PID: ${process.pid}`);\n\n  const server = await startWorkerServer(handlers);\n\n  console.log('Worker ready and accepting requests');\n\n  process.on('SIGTERM', async () => {\n    console.log('Worker received SIGTERM');\n    await server.stop();\n    process.exit(0);\n  });\n}\n\nmain().catch((err) => {\n  console.error('Worker error:', err);\n  process.exit(1);\n});\n","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shutdown Handling Example - Worker (Server) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This worker demonstrates various scenarios including:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Normal message processing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Crashing during processing (for retry testing)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Processing that takes time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\" title=\"View startWorkerServer documentation\">startWorkerServer</a>, <a href=\"/isolated-workers/api/handlers\" class=\"code-link\" title=\"View Handlers documentation\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\" title=\"View Handlers documentation\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  compute</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: computing ${</span><span style=\"color:#E1E4E8\">value</span><span style=\"color:#9ECBFF\">}^2 (shouldCrash=${</span><span style=\"color:#E1E4E8\">shouldCrash</span><span style=\"color:#9ECBFF\">})`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (shouldCrash) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing as requested'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { result: value </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> value };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  processPayment</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">paymentId</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">amount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: processing payment ${</span><span style=\"color:#E1E4E8\">paymentId</span><span style=\"color:#9ECBFF\">} for $${</span><span style=\"color:#E1E4E8\">amount</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (shouldCrash) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing during payment processing'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { success: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  processBatch</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">items</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">crashAfterItems</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: processing batch of ${</span><span style=\"color:#E1E4E8\">items</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#9ECBFF\">} items`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (crashAfterItems </span><span style=\"color:#F97583\">!==</span><span style=\"color:#79B8FF\"> undefined</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> crashAfterItems </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        `Worker: will crash after processing ${</span><span style=\"color:#E1E4E8\">crashAfterItems</span><span style=\"color:#9ECBFF\">} items`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      );</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // Process up to the crash point, then crash</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      for</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> Math.</span><span style=\"color:#B392F0\">min</span><span style=\"color:#E1E4E8\">(crashAfterItems, items.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\">); i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Simulate processing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        items[i] </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing as requested'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { processed: items.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker starting...'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker PID: ${</span><span style=\"color:#E1E4E8\">process</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> server</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\" title=\"View startWorkerServer documentation\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker ready and accepting requests'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">on</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'SIGTERM'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker received SIGTERM'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> server.</span><span style=\"color:#B392F0\">stop</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"},{"type":"html","html":"<h2>Running the Example</h2>\n<pre><code class=\"language-bash\">cd examples &#x26;&#x26; pnpm run:shutdown-handling\n</code></pre>\n<h2>Key Concepts</h2>\n<h3>Worker-Level Default Strategy</h3>\n<p>The top-level <code class=\"inline-code\">unexpectedShutdown.strategy</code> applies to all message types by default:</p>\n<pre><code class=\"language-typescript\">const worker = await createWorker&#x3C;Messages>({\n  script: './worker.js',\n  unexpectedShutdown: {\n    strategy: 'reject', // default for all messages\n  },\n});\n</code></pre>\n<h3>Per-Message-Type Overrides</h3>\n<p>Override the default for specific message types:</p>\n<pre><code class=\"language-typescript\">const worker = await createWorker&#x3C;Messages>({\n  script: './worker.js',\n  unexpectedShutdown: {\n    strategy: 'reject', // default for most\n    compute: { strategy: 'retry', attempts: 2 }, // override for compute\n    processBatch: { strategy: 'retry' }, // override with default 1\n  },\n});\n</code></pre>\n<h3>WorkerCrashedError</h3>\n<p>When a crash occurs (or retries are exhausted), requests reject with <code class=\"inline-code\"><a class=\"code-link\" href=\"/isolated-workers/isolated-workers/api/worker-crashed-error\">WorkerCrashedError</a></code>:</p>\n<pre><code class=\"language-typescript\">try {\n  await worker.send('processPayment', { paymentId: '123', amount: 100 });\n} catch (err) {\n  if (err instanceof WorkerCrashedError) {\n    console.error('Worker crashed:', err.message);\n    console.error('Reason:', err.reason); // exit code, signal, or error\n    console.error('Attempt:', err.attempt, '/', err.maxAttempts);\n  }\n}\n</code></pre>\n<h3>Retry Flow</h3>\n<ol>\n<li>Worker crashes (exit, error, or close event)</li>\n<li><code class=\"inline-code\">handleUnexpectedShutdown()</code> called for each pending request</li>\n<li>For each request:\n<ul>\n<li>Look up strategy for its message type</li>\n<li>If <code class=\"inline-code\">reject</code> OR <code class=\"inline-code\">attempt >= maxAttempts</code> → reject with <code class=\"inline-code\"><a class=\"code-link\" href=\"/isolated-workers/isolated-workers/api/worker-crashed-error\">WorkerCrashedError</a></code></li>\n<li>If <code class=\"inline-code\">retry</code> AND <code class=\"inline-code\">attempt &#x3C; maxAttempts</code> → queue for retry</li>\n</ul>\n</li>\n<li>If any requests queued → spawn new worker, re-send each with <code class=\"inline-code\">attempt++</code></li>\n<li>Original Promise stays the same—user awaits the same resolve/reject</li>\n</ol>\n<h3>Crash Detection</h3>\n<p>The library detects crashes via exit events, which fire reliably even for:</p>\n<ul>\n<li>OOM kills (SIGKILL)</li>\n<li>Hard crashes (uncaught exceptions without handlers)</li>\n<li>Manual termination (<code class=\"inline-code\">kill -9 <pid></pid></code>)</li>\n</ul>\n<pre><code class=\"language-typescript\">// Detection happens automatically:\nchild.on('exit', (code, signal) => {\n  // Triggers shutdown handling for all pending requests\n});\n</code></pre>"}],"files":[{"filename":"messages.ts","content":"/**\n * Shared message definitions for the shutdown-handling example\n *\n * This file is imported by both the host and worker to ensure\n * type safety and avoid duplication.\n */\n\nimport { DefineMessages } from 'isolated-workers';\n\n/**\n * Message types demonstrating different shutdown scenarios\n */\nexport type Messages = DefineMessages<{\n  // Idempotent operation - safe to retry\n  compute: {\n    payload: { value: number; shouldCrash?: boolean };\n    result: { result: number };\n  };\n\n  // Non-idempotent operation - should reject on crash\n  processPayment: {\n    payload: { paymentId: string; amount: number; shouldCrash?: boolean };\n    result: { success: boolean };\n  };\n\n  // Operation that may fail - demonstrate retry limits\n  processBatch: {\n    payload: { items: number[]; crashAfterItems?: number };\n    result: { processed: number };\n  };\n}>;\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shared message definitions for the shutdown-handling example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This file is imported by both the host and worker to ensure</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * type safety and avoid duplication.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Message types demonstrating different shutdown scenarios</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> Messages</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a></span><span style=\"color:#E1E4E8\">&#x3C;{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Idempotent operation - safe to retry</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  compute</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">result</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Non-idempotent operation - should reject on crash</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  processPayment</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">paymentId</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">amount</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">success</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Operation that may fail - demonstrate retry limits</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  processBatch</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">items</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">[]; </span><span style=\"color:#FFAB70\">crashAfterItems</span><span style=\"color:#F97583\">?:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">processed</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}>;</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"host.ts","content":"/**\n * Shutdown Handling Example - Host (Client) Side\n *\n * Demonstrates different strategies for handling unexpected worker crashes:\n * - 'reject' strategy: Immediately reject pending requests\n * - 'retry' strategy: Automatically retry failed requests\n * - Per-message-type overrides: Different strategies for different operations\n */\n\nimport { createWorker, WorkerCrashedError } from 'isolated-workers';\nimport { fileURLToPath } from 'url';\nimport { dirname, join } from 'path';\nimport type { Messages } from './messages.js';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nasync function createTestWorker() {\n  return createWorker<Messages>({\n    script: join(__dirname, 'worker.ts'),\n    timeout: 10000,\n    unexpectedShutdown: {\n      strategy: 'reject', // default for all messages\n      compute: { strategy: 'retry', attempts: 3 }, // retry idempotent ops up to 3 times\n      processBatch: { strategy: 'retry', attempts: 3 }, // retry with limit\n      // processPayment uses default 'reject' - non-idempotent\n    },\n  });\n}\n\nasync function main() {\n  console.log('=== Shutdown Handling Example ===\\n');\n\n  let worker = await createTestWorker();\n  console.log(`Worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 1: Normal operation (no crash)\n  console.log('Test 1: Normal operation');\n  try {\n    const result = await worker.send('compute', { value: 5 });\n    console.log('✓ Result:', result.result, '\\n');\n  } catch (err) {\n    console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n  }\n\n  // Test 2: Idempotent operation with crash (retry will also crash - demonstrates exhaustion)\n  // Note: When a worker crashes, the retry spawns a NEW worker process.\n  // If the crash condition is in the payload (shouldCrash: true), retries will also crash.\n  // This demonstrates retry exhaustion for idempotent operations.\n  console.log('Test 2: Idempotent operation with crash - retry exhaustion');\n  try {\n    const result = await worker.send('compute', {\n      value: 7,\n      shouldCrash: true, // Will crash on every attempt\n    });\n    console.log('✗ Should have crashed, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError after retries:', err.message);\n      console.log(`  - Reason: ${err.reason.type}`);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need a fresh worker since Test 2 exhausted retries\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 3: Non-idempotent operation (should reject immediately, no retry)\n  console.log('Test 3: Non-idempotent operation (should reject, not retry)');\n  try {\n    // This payment will crash, and since processPayment uses 'reject' strategy,\n    // it should fail with WorkerCrashedError immediately (no retries)\n    const result = await worker.send('processPayment', {\n      paymentId: 'pay-123',\n      amount: 100,\n      shouldCrash: true,\n    });\n    console.log('✗ Payment should have been rejected, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError (as expected):', err.message);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}`);\n      console.log(`  - No retries (non-idempotent operation)\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need a fresh worker since Test 3 crashed\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 4: Batch processing with retry exhaustion\n  console.log('Test 4: Batch processing with retry exhaustion');\n  try {\n    // This batch will crash immediately (crashAfterItems: 0), and will keep crashing\n    // until we exhaust all 3 retry attempts\n    const result = await worker.send('processBatch', {\n      items: [1, 2, 3, 4, 5],\n      crashAfterItems: 0, // Crash immediately every time\n    });\n    console.log('✗ Should have exhausted retries, got:', result, '\\n');\n  } catch (err) {\n    if (err instanceof WorkerCrashedError) {\n      console.log('✓ WorkerCrashedError after retries:', err.message);\n      console.log(`  - Attempt: ${err.attempt}/${err.maxAttempts}\\n`);\n    } else {\n      console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n    }\n  }\n\n  // Need another fresh worker since Test 4 exhausted retries\n  await worker.close();\n  worker = await createTestWorker();\n  console.log(`Fresh worker spawned with PID: ${worker.pid}\\n`);\n\n  // Test 5: Successful batch processing (no crash)\n  console.log('Test 5: Successful batch processing');\n  try {\n    const result = await worker.send('processBatch', {\n      items: [1, 2, 3],\n      // No crashAfterItems = no crash\n    });\n    console.log('✓ Processed batch of', result.processed, 'items\\n');\n  } catch (err) {\n    console.error('✗ Unexpected error:', (err as Error).message, '\\n');\n  }\n\n  // Test 6: Cleanup\n  console.log('Test 6: Cleanup');\n  await worker.close();\n  console.log('✓ Worker closed successfully\\n');\n\n  console.log('=== All tests completed ===');\n}\n\nmain().catch((err) => {\n  console.error('Host error:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shutdown Handling Example - Host (Client) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Demonstrates different strategies for handling unexpected worker crashes:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - 'reject' strategy: Immediately reject pending requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - 'retry' strategy: Automatically retry failed requests</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Per-message-type overrides: Different strategies for different operations</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a>, <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { fileURLToPath } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'url'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { dirname, join } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'path'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> __dirname</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> dirname</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">fileURLToPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">meta</span><span style=\"color:#E1E4E8\">.url));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    script: </span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(__dirname, </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeout: </span><span style=\"color:#79B8FF\">10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    unexpectedShutdown: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      strategy: </span><span style=\"color:#9ECBFF\">'reject'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// default for all messages</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      compute: { strategy: </span><span style=\"color:#9ECBFF\">'retry'</span><span style=\"color:#E1E4E8\">, attempts: </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\"> }, </span><span style=\"color:#6A737D\">// retry idempotent ops up to 3 times</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      processBatch: { strategy: </span><span style=\"color:#9ECBFF\">'retry'</span><span style=\"color:#E1E4E8\">, attempts: </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\"> }, </span><span style=\"color:#6A737D\">// retry with limit</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // processPayment uses default 'reject' - non-idempotent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'=== Shutdown Handling Example ===</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  let</span><span style=\"color:#E1E4E8\"> worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 1: Normal operation (no crash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 1: Normal operation'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, { value: </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Result:'</span><span style=\"color:#E1E4E8\">, result.result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 2: Idempotent operation with crash (retry will also crash - demonstrates exhaustion)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Note: When a worker crashes, the retry spawns a NEW worker process.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // If the crash condition is in the payload (shouldCrash: true), retries will also crash.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // This demonstrates retry exhaustion for idempotent operations.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 2: Idempotent operation with crash - retry exhaustion'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      value: </span><span style=\"color:#79B8FF\">7</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      shouldCrash: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Will crash on every attempt</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Should have crashed, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a> after retries:'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Reason: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">reason</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need a fresh worker since Test 2 exhausted retries</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 3: Non-idempotent operation (should reject immediately, no retry)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 3: Non-idempotent operation (should reject, not retry)'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This payment will crash, and since processPayment uses 'reject' strategy,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // it should fail with WorkerCrashedError immediately (no retries)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processPayment'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      paymentId: </span><span style=\"color:#9ECBFF\">'pay-123'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      amount: </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      shouldCrash: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Payment should have been rejected, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a> (as expected):'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - No retries (non-idempotent operation)</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need a fresh worker since Test 3 crashed</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 4: Batch processing with retry exhaustion</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 4: Batch processing with retry exhaustion'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This batch will crash immediately (crashAfterItems: 0), and will keep crashing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // until we exhaust all 3 retry attempts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processBatch'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      items: [</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      crashAfterItems: </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Crash immediately every time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Should have exhausted retries, got:'</span><span style=\"color:#E1E4E8\">, result, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">instanceof</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a></span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ <a href=\"/isolated-workers/api/worker-crashed-error\" class=\"code-link\">WorkerCrashedError</a> after retries:'</span><span style=\"color:#E1E4E8\">, err.message);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`  - Attempt: ${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">attempt</span><span style=\"color:#9ECBFF\">}/${</span><span style=\"color:#E1E4E8\">err</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">maxAttempts</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Need another fresh worker since Test 4 exhausted retries</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> createTestWorker</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Fresh worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 5: Successful batch processing (no crash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 5: Successful batch processing'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processBatch'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      items: [</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // No crashAfterItems = no crash</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Processed batch of'</span><span style=\"color:#E1E4E8\">, result.processed, </span><span style=\"color:#9ECBFF\">'items</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> (err) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✗ Unexpected error:'</span><span style=\"color:#E1E4E8\">, (err </span><span style=\"color:#F97583\">as</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">).message, </span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Test 6: Cleanup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Test 6: Cleanup'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'✓ Worker closed successfully</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'=== All tests completed ==='</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Host error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"worker.ts","content":"/**\n * Shutdown Handling Example - Worker (Server) Side\n *\n * This worker demonstrates various scenarios including:\n * - Normal message processing\n * - Crashing during processing (for retry testing)\n * - Processing that takes time\n */\n\nimport { startWorkerServer, Handlers } from 'isolated-workers';\nimport type { Messages } from './messages.js';\n\nconst handlers: Handlers<Messages> = {\n  compute: ({ value, shouldCrash = false }) => {\n    console.log(`Worker: computing ${value}^2 (shouldCrash=${shouldCrash})`);\n\n    if (shouldCrash) {\n      console.log('Worker: crashing as requested');\n      process.exit(1);\n    }\n\n    return { result: value * value };\n  },\n\n  processPayment: ({ paymentId, amount, shouldCrash = false }) => {\n    console.log(`Worker: processing payment ${paymentId} for $${amount}`);\n\n    if (shouldCrash) {\n      console.log('Worker: crashing during payment processing');\n      process.exit(1);\n    }\n\n    return { success: true };\n  },\n\n  processBatch: ({ items, crashAfterItems }) => {\n    console.log(`Worker: processing batch of ${items.length} items`);\n\n    if (crashAfterItems !== undefined && crashAfterItems >= 0) {\n      console.log(\n        `Worker: will crash after processing ${crashAfterItems} items`\n      );\n      // Process up to the crash point, then crash\n      for (let i = 0; i < Math.min(crashAfterItems, items.length); i++) {\n        // Simulate processing\n        items[i] * 2;\n      }\n      console.log('Worker: crashing as requested');\n      process.exit(1);\n    }\n\n    return { processed: items.length };\n  },\n};\n\nasync function main() {\n  console.log('Worker starting...');\n  console.log(`Worker PID: ${process.pid}`);\n\n  const server = await startWorkerServer(handlers);\n\n  console.log('Worker ready and accepting requests');\n\n  process.on('SIGTERM', async () => {\n    console.log('Worker received SIGTERM');\n    await server.stop();\n    process.exit(0);\n  });\n}\n\nmain().catch((err) => {\n  console.error('Worker error:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shutdown Handling Example - Worker (Server) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This worker demonstrates various scenarios including:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Normal message processing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Crashing during processing (for retry testing)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * - Processing that takes time</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a>, <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  compute</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">value</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: computing ${</span><span style=\"color:#E1E4E8\">value</span><span style=\"color:#9ECBFF\">}^2 (shouldCrash=${</span><span style=\"color:#E1E4E8\">shouldCrash</span><span style=\"color:#9ECBFF\">})`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (shouldCrash) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing as requested'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { result: value </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> value };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  processPayment</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">paymentId</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">amount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shouldCrash</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: processing payment ${</span><span style=\"color:#E1E4E8\">paymentId</span><span style=\"color:#9ECBFF\">} for $${</span><span style=\"color:#E1E4E8\">amount</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (shouldCrash) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing during payment processing'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { success: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  processBatch</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">items</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">crashAfterItems</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker: processing batch of ${</span><span style=\"color:#E1E4E8\">items</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#9ECBFF\">} items`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> (crashAfterItems </span><span style=\"color:#F97583\">!==</span><span style=\"color:#79B8FF\"> undefined</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> crashAfterItems </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        `Worker: will crash after processing ${</span><span style=\"color:#E1E4E8\">crashAfterItems</span><span style=\"color:#9ECBFF\">} items`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      );</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // Process up to the crash point, then crash</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      for</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> Math.</span><span style=\"color:#B392F0\">min</span><span style=\"color:#E1E4E8\">(crashAfterItems, items.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\">); i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Simulate processing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        items[i] </span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\"> 2</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker: crashing as requested'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> { processed: items.</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker starting...'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker PID: ${</span><span style=\"color:#E1E4E8\">process</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> server</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker ready and accepting requests'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">on</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'SIGTERM'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker received SIGTERM'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> server.</span><span style=\"color:#B392F0\">stop</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"}],"renderedFiles":["messages.ts","host.ts","worker.ts"]}}