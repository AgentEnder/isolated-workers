{"pageId":"/pages/examples/@id","routeParams":{"id":"image-processing"},"data":{"example":{"id":"image-processing","path":"/home/runner/work/isolated-workers/isolated-workers/examples/image-processing","title":"Image Processing Worker","description":"A complete example demonstrating how to build a production-ready worker\nfor CPU-intensive tasks like image processing. Shows type-safe messaging,\nper-operation timeouts, worker state, and batch processing.\n","entryPoint":"host.ts","fileMap":{"./messages.ts":"messages.ts","./host.ts":"host.ts","./worker.ts":"worker.ts"},"commands":[{"command":"pnpm run:image-processing","title":"Run the example","assertions":[{"contains":"Worker PID:"},{"contains":"Image metadata:"},{"contains":"Worker status:"},{"contains":"Batch result:"},{"contains":"Worker shut down gracefully"}]}],"hidden":true},"segments":[{"type":"html","html":"<h1>Image Processing Worker</h1>\n<p>A complete example demonstrating how to build a production-ready worker\nfor CPU-intensive tasks like image processing. Shows type-safe messaging,\nper-operation timeouts, worker state, and batch processing.</p>"}],"files":[{"filename":"messages.ts","content":"/**\n * Image Processing Worker - Message Definitions\n *\n * Shared message types for the image processing example.\n */\n\nimport type { DefineMessages } from 'isolated-workers';\n\nexport type Messages = DefineMessages<{\n  // Process an image and return metadata\n  processImage: {\n    payload: {\n      imagePath: string;\n      options: { grayscale: boolean; quality: number };\n    };\n    result: {\n      width: number;\n      height: number;\n      format: string;\n      size: number;\n    };\n  };\n\n  // Batch process multiple images\n  batchProcess: {\n    payload: {\n      paths: string[];\n      options: { grayscale: boolean; quality: number };\n    };\n    result: {\n      successful: number;\n      failed: number;\n      results: Array<{ path: string; success: boolean }>;\n    };\n  };\n\n  // Get current worker status\n  getStatus: {\n    payload: Record<string, never>;\n    result: {\n      active: boolean;\n      processedCount: number;\n    };\n  };\n}>;\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Image Processing Worker - Message Definitions</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shared message types for the image processing example.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> Messages</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a></span><span style=\"color:#E1E4E8\">&#x3C;{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Process an image and return metadata</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  processImage</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      imagePath</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      options</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">grayscale</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">quality</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      width</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      height</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      format</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      size</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Batch process multiple images</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  batchProcess</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      paths</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">[];</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      options</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">grayscale</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">quality</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      successful</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      failed</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      results</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Array</span><span style=\"color:#E1E4E8\">&#x3C;{ </span><span style=\"color:#FFAB70\">path</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">success</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\"> }>;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Get current worker status</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  getStatus</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Record</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">never</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      active</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> boolean</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      processedCount</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}>;</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"host.ts","content":"/**\n * Image Processing Worker - Host Side\n *\n * Demonstrates spawning a worker for CPU-intensive image processing\n * with type-safe messaging and per-operation timeouts.\n */\n\nimport { createWorker } from 'isolated-workers';\nimport { fileURLToPath } from 'url';\nimport { dirname, join } from 'path';\nimport type { Messages } from './messages.js';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nasync function main() {\n  console.log('Starting image processing example...\\n');\n\n  // Spawn the worker with per-operation timeouts\n  const worker = await createWorker<Messages>({\n    script: join(__dirname, 'worker.ts'),\n    // Configure timeouts for different operations\n    timeout: {\n      WORKER_STARTUP: 5000, // 5s to start\n      processImage: 30000, // 30s per image\n      batchProcess: 300000, // 5min for batch\n    },\n  });\n\n  console.log('Worker PID:', worker.pid);\n  // PID is the process ID of the spawned worker\n  // Returns `undefined` for worker_threads (which share parent's PID)\n  // Returns a number for child_process workers (unique process ID)\n\n  try {\n    // Process a single image\n    const metadata = await worker.send('processImage', {\n      imagePath: './photo.jpg',\n      options: { grayscale: true, quality: 85 },\n    });\n    console.log('Image metadata:', metadata);\n\n    // Check worker status\n    const status = await worker.send('getStatus', {});\n    console.log('Worker status:', status);\n\n    // Batch process multiple images\n    const batchResult = await worker.send('batchProcess', {\n      paths: ['./a.jpg', './b.jpg', './c.jpg'],\n      options: { grayscale: false, quality: 90 },\n    });\n    console.log('Batch result:', batchResult);\n  } finally {\n    // Always clean up\n    await worker.close();\n    console.log('Worker shut down gracefully');\n  }\n}\n\nmain().catch(console.error);\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Image Processing Worker - Host Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Demonstrates spawning a worker for CPU-intensive image processing</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * with type-safe messaging and per-operation timeouts.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { fileURLToPath } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'url'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { dirname, join } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'path'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> __dirname</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> dirname</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">fileURLToPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">meta</span><span style=\"color:#E1E4E8\">.url));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Starting image processing example...</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Spawn the worker with per-operation timeouts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    script: </span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(__dirname, </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Configure timeouts for different operations</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeout: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      WORKER_STARTUP: </span><span style=\"color:#79B8FF\">5000</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// 5s to start</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      processImage: </span><span style=\"color:#79B8FF\">30000</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// 30s per image</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      batchProcess: </span><span style=\"color:#79B8FF\">300000</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// 5min for batch</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker PID:'</span><span style=\"color:#E1E4E8\">, worker.pid);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // PID is the process ID of the spawned worker</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Returns `undefined` for worker_threads (which share parent's PID)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Returns a number for child_process workers (unique process ID)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Process a single image</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> metadata</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processImage'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      imagePath: </span><span style=\"color:#9ECBFF\">'./photo.jpg'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      options: { grayscale: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">, quality: </span><span style=\"color:#79B8FF\">85</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Image metadata:'</span><span style=\"color:#E1E4E8\">, metadata);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Check worker status</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> status</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'getStatus'</span><span style=\"color:#E1E4E8\">, {});</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker status:'</span><span style=\"color:#E1E4E8\">, status);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Batch process multiple images</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> batchResult</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'batchProcess'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      paths: [</span><span style=\"color:#9ECBFF\">'./a.jpg'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'./b.jpg'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">'./c.jpg'</span><span style=\"color:#E1E4E8\">],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      options: { grayscale: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, quality: </span><span style=\"color:#79B8FF\">90</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Batch result:'</span><span style=\"color:#E1E4E8\">, batchResult);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Always clean up</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker shut down gracefully'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">(console.error);</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"worker.ts","content":"/**\n * Image Processing Worker - Worker Side\n *\n * Handles image processing operations in an isolated process.\n */\n\nimport { startWorkerServer, Handlers } from 'isolated-workers';\nimport type { Messages } from './messages.js';\n\n// Track processing statistics\nlet processedCount = 0;\n\n// Helper to simulate work\nasync function simulateProcessing() {\n  return new Promise((resolve) => setTimeout(resolve, 100));\n}\n\nconst handlers: Handlers<Messages> = {\n  processImage: async ({ imagePath }) => {\n    // Simulate image processing (replace with real logic)\n    console.log(`Processing: ${imagePath}`);\n\n    // In a real implementation, you would use sharp, jimp, or similar\n    await simulateProcessing();\n\n    processedCount++;\n\n    return {\n      width: 1920,\n      height: 1080,\n      format: 'jpeg',\n      size: 256000,\n    };\n  },\n\n  batchProcess: async ({ paths }) => {\n    const results = [];\n\n    for (const path of paths) {\n      try {\n        await simulateProcessing();\n        results.push({ path, success: true });\n      } catch {\n        results.push({ path, success: false });\n      }\n    }\n\n    return {\n      successful: results.filter((r) => r.success).length,\n      failed: results.filter((r) => !r.success).length,\n      results,\n    };\n  },\n\n  getStatus: async () => {\n    return {\n      active: true,\n      processedCount,\n    };\n  },\n};\n\nasync function main() {\n  const server = await startWorkerServer(handlers);\n\n  console.log(\n    'Image worker started on',\n    process.env.ISOLATED_WORKERS_SOCKET_PATH\n  );\n\n  process.on('SIGTERM', async () => {\n    await server.stop();\n    process.exit(0);\n  });\n}\n\nmain().catch((err) => {\n  console.error('Worker error:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Image Processing Worker - Worker Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Handles image processing operations in an isolated process.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a>, <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Track processing statistics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> processedCount </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Helper to simulate work</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> simulateProcessing</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#F97583\"> new</span><span style=\"color:#79B8FF\"> Promise</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">resolve</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> setTimeout</span><span style=\"color:#E1E4E8\">(resolve, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">));</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  processImage</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> ({ </span><span style=\"color:#FFAB70\">imagePath</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Simulate image processing (replace with real logic)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Processing: ${</span><span style=\"color:#E1E4E8\">imagePath</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // In a real implementation, you would use sharp, jimp, or similar</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#B392F0\"> simulateProcessing</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processedCount</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      width: </span><span style=\"color:#79B8FF\">1920</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      height: </span><span style=\"color:#79B8FF\">1080</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      format: </span><span style=\"color:#9ECBFF\">'jpeg'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      size: </span><span style=\"color:#79B8FF\">256000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  batchProcess</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> ({ </span><span style=\"color:#FFAB70\">paths</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> results</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> [];</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> path</span><span style=\"color:#F97583\"> of</span><span style=\"color:#E1E4E8\"> paths) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        await</span><span style=\"color:#B392F0\"> simulateProcessing</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        results.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">({ path, success: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        results.</span><span style=\"color:#B392F0\">push</span><span style=\"color:#E1E4E8\">({ path, success: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      successful: results.</span><span style=\"color:#B392F0\">filter</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> r.success).</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      failed: results.</span><span style=\"color:#B392F0\">filter</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">r.success).</span><span style=\"color:#79B8FF\">length</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      results,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  getStatus</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      active: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      processedCount,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> server</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    'Image worker started on'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.env.</span><span style=\"color:#79B8FF\">ISOLATED_WORKERS_SOCKET_PATH</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  );</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">on</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'SIGTERM'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> server.</span><span style=\"color:#B392F0\">stop</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"}],"renderedFiles":[]}}