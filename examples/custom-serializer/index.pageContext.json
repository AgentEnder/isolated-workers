{"pageId":"/pages/examples/@id","routeParams":{"id":"custom-serializer"},"data":{"example":{"id":"custom-serializer","path":"/home/runner/work/isolated-workers/isolated-workers/examples/custom-serializer","title":"Custom Serializer","description":"Shows how to implement and use a custom serializer for message encoding. This is useful for using binary formats like MessagePack, adding compression, or wrapping messages with metadata. Both host and worker must use the same serializer.\n","entryPoint":"host.ts","fileMap":{"./messages.ts":"messages.ts","./serializer.ts":"serializer.ts","./host.ts":"host.ts","./worker.ts":"worker.ts"},"commands":[{"command":"pnpm run:custom-serializer","title":"Run the example","assertions":[{"contains":"VerboseJsonSerializer"},{"contains":"[SERIALIZER] Message #"},{"contains":"HELLO, CUSTOM SERIALIZER!"},{"contains":"Worker closed successfully"}]}],"hidden":false},"segments":[{"type":"html","html":"<h1>Custom Serializer</h1>\n<p>Shows how to implement and use a custom serializer for message encoding. This is useful for using binary formats like MessagePack, adding compression, or wrapping messages with metadata. Both host and worker must use the same serializer.</p>"}],"files":[{"filename":"messages.ts","content":"/**\n * Shared message definitions for the custom serializer example\n */\n\nimport { DefineMessages } from 'isolated-workers';\n\n/**\n * Message types for the serializer example\n */\nexport type Messages = DefineMessages<{\n  echo: {\n    payload: { data: string };\n    result: { echoed: string; serializer: string };\n  };\n}>;\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Shared message definitions for the custom serializer example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Message types for the serializer example</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> type</span><span style=\"color:#B392F0\"> Messages</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/define-messages\" class=\"code-link\">DefineMessages</a></span><span style=\"color:#E1E4E8\">&#x3C;{</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  echo</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    payload</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">data</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    result</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">echoed</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#FFAB70\">serializer</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}>;</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"host.ts","content":"/**\n * Custom Serializer Example - Host (Client) Side\n *\n * This example demonstrates how to use a custom serializer for\n * message encoding/decoding. Both host and worker must use the\n * same serializer class.\n */\n\nimport { createWorker } from 'isolated-workers';\nimport { fileURLToPath } from 'url';\nimport { dirname, join } from 'path';\nimport type { Messages } from './messages.js';\nimport { verboseSerializer } from './serializer.js';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n\nasync function main() {\n  console.log('Starting custom serializer example...\\n');\n  console.log('Using:', verboseSerializer.constructor.name);\n  console.log(\n    'Terminator:',\n    JSON.stringify(verboseSerializer.terminator),\n    '\\n'\n  );\n\n  const worker = await createWorker<Messages>({\n    script: join(__dirname, 'worker.ts'),\n    timeout: 10000,\n    serializer: verboseSerializer,\n  });\n\n  console.log(`Worker spawned with PID: ${worker.pid}\\n`);\n\n  try {\n    // Send a message using our custom serializer\n    console.log('Sending message with custom serialization...');\n    const result = await worker.send('echo', {\n      data: 'Hello, Custom Serializer!',\n    });\n\n    console.log('\\nResult received:');\n    console.log('  Echoed:', result.echoed);\n    console.log('  Worker serializer:', result.serializer);\n  } finally {\n    await worker.close();\n    console.log('\\nWorker closed successfully');\n  }\n}\n\nmain().catch((err) => {\n  console.error('Error:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Custom Serializer Example - Host (Client) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This example demonstrates how to use a custom serializer for</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * message encoding/decoding. Both host and worker must use the</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * same serializer class.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { fileURLToPath } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'url'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { dirname, join } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'path'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { verboseSerializer } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './serializer.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> __dirname</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> dirname</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">fileURLToPath</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">meta</span><span style=\"color:#E1E4E8\">.url));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Starting custom serializer example...</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Using:'</span><span style=\"color:#E1E4E8\">, verboseSerializer.</span><span style=\"color:#79B8FF\">constructor</span><span style=\"color:#E1E4E8\">.name);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    'Terminator:'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    JSON</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">stringify</span><span style=\"color:#E1E4E8\">(verboseSerializer.terminator),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    '</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  );</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    script: </span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(__dirname, </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeout: </span><span style=\"color:#79B8FF\">10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    serializer: verboseSerializer,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker spawned with PID: ${</span><span style=\"color:#E1E4E8\">worker</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">pid</span><span style=\"color:#9ECBFF\">}</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Send a message using our custom serializer</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Sending message with custom serialization...'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'echo'</span><span style=\"color:#E1E4E8\">, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      data: </span><span style=\"color:#9ECBFF\">'Hello, Custom <a href=\"/isolated-workers/api/serializer\" class=\"code-link\">Serializer</a>!'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">Result received:'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'  Echoed:'</span><span style=\"color:#E1E4E8\">, result.echoed);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'  Worker serializer:'</span><span style=\"color:#E1E4E8\">, result.serializer);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">Worker closed successfully'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"worker.ts","content":"/**\n * Custom Serializer Example - Worker (Server) Side\n *\n * The worker must use the same serializer as the host.\n */\n\nimport { startWorkerServer, Handlers } from 'isolated-workers';\nimport type { Messages } from './messages.js';\nimport { verboseSerializer } from './serializer.js';\n\nconst handlers: Handlers<Messages> = {\n  echo: ({ data }) => {\n    console.log(`Worker received: \"${data}\"`);\n    return {\n      echoed: data.toUpperCase(),\n      serializer: verboseSerializer.constructor.name,\n    };\n  },\n};\n\nasync function main() {\n  console.log('Worker starting with custom serializer...');\n  console.log('Using:', verboseSerializer.constructor.name);\n\n  const server = await startWorkerServer(handlers, {\n    serializer: verboseSerializer,\n  });\n\n  console.log('Worker ready');\n\n  process.on('SIGTERM', async () => {\n    await server.stop();\n    process.exit(0);\n  });\n}\n\nmain().catch((err) => {\n  console.error('Worker error:', err);\n  process.exit(1);\n});\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Custom Serializer Example - Worker (Server) Side</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * The worker must use the same serializer as the host.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a>, <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { verboseSerializer } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './serializer.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  echo</span><span style=\"color:#E1E4E8\">: ({ </span><span style=\"color:#FFAB70\">data</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Worker received: \"${</span><span style=\"color:#E1E4E8\">data</span><span style=\"color:#9ECBFF\">}\"`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      echoed: data.</span><span style=\"color:#B392F0\">toUpperCase</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      serializer: verboseSerializer.</span><span style=\"color:#79B8FF\">constructor</span><span style=\"color:#E1E4E8\">.name,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker starting with custom serializer...'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Using:'</span><span style=\"color:#E1E4E8\">, verboseSerializer.</span><span style=\"color:#79B8FF\">constructor</span><span style=\"color:#E1E4E8\">.name);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> server</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    serializer: verboseSerializer,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker ready'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">on</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'SIGTERM'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> server.</span><span style=\"color:#B392F0\">stop</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">main</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">catch</span><span style=\"color:#E1E4E8\">((</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Worker error:'</span><span style=\"color:#E1E4E8\">, err);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  process.</span><span style=\"color:#B392F0\">exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"></span></code></pre>"},{"filename":"serializer.ts","content":"/**\n * Custom Serializer Implementation\n *\n * This example shows how to create a custom serializer.\n * A real use case might be using MessagePack, Protocol Buffers,\n * or adding compression/encryption.\n *\n * IMPORTANT: The serializer class must be named (not anonymous)\n * for mismatch detection to work properly.\n */\n\nimport { Serializer } from 'isolated-workers';\n\n/**\n * A verbose JSON serializer that adds metadata to each message.\n * This is for demonstration - in production you might use a more\n * efficient binary format.\n */\nexport class VerboseJsonSerializer extends Serializer {\n  private static messageCount = 0;\n\n  serialize<T>(data: T): string {\n    VerboseJsonSerializer.messageCount++;\n    const wrapped = {\n      _serializer: 'VerboseJsonSerializer',\n      _messageId: VerboseJsonSerializer.messageCount,\n      _timestamp: Date.now(),\n      data,\n    };\n    return JSON.stringify(wrapped);\n  }\n\n  deserialize<T>(input: string | Uint8Array): T {\n    const str =\n      typeof input === 'string' ? input : new TextDecoder().decode(input);\n    const wrapped = JSON.parse(str) as {\n      _serializer: string;\n      _messageId: number;\n      _timestamp: number;\n      data: T;\n    };\n\n    // Log metadata (in real code, you might use this for debugging/tracing)\n    console.log(\n      `[SERIALIZER] Message #${wrapped._messageId} from ${wrapped._serializer}`\n    );\n\n    return wrapped.data;\n  }\n\n  // Custom terminator - using double newline to avoid conflicts\n  terminator = '\\n\\n';\n}\n\n// Export a singleton instance for convenience\nexport const verboseSerializer = new VerboseJsonSerializer();\n","language":"typescript","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Custom Serializer Implementation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This example shows how to create a custom serializer.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * A real use case might be using MessagePack, Protocol Buffers,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * or adding compression/encryption.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> *</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * IMPORTANT: The serializer class must be named (not anonymous)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * for mismatch detection to work properly.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/serializer\" class=\"code-link\">Serializer</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * A verbose JSON serializer that adds metadata to each message.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * This is for demonstration - in production you might use a more</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * efficient binary format.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> class</span><span style=\"color:#B392F0\"> VerboseJsonSerializer</span><span style=\"color:#F97583\"> extends</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/serializer\" class=\"code-link\">Serializer</a></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  private</span><span style=\"color:#F97583\"> static</span><span style=\"color:#FFAB70\"> messageCount</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  serialize</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">>(</span><span style=\"color:#FFAB70\">data</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> T</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    VerboseJsonSerializer.messageCount</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> wrapped</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      _serializer: </span><span style=\"color:#9ECBFF\">'VerboseJsonSerializer'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      _messageId: VerboseJsonSerializer.messageCount,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      _timestamp: Date.</span><span style=\"color:#B392F0\">now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      data,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> JSON</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">stringify</span><span style=\"color:#E1E4E8\">(wrapped);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  deserialize</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">>(</span><span style=\"color:#FFAB70\">input</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> Uint8Array</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> T</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> str</span><span style=\"color:#F97583\"> =</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      typeof</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">===</span><span style=\"color:#9ECBFF\"> 'string'</span><span style=\"color:#F97583\"> ?</span><span style=\"color:#E1E4E8\"> input </span><span style=\"color:#F97583\">:</span><span style=\"color:#F97583\"> new</span><span style=\"color:#B392F0\"> TextDecoder</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">decode</span><span style=\"color:#E1E4E8\">(input);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> wrapped</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> JSON</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">parse</span><span style=\"color:#E1E4E8\">(str) </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      _serializer</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> string</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      _messageId</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      _timestamp</span><span style=\"color:#F97583\">:</span><span style=\"color:#79B8FF\"> number</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">      data</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> T</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Log metadata (in real code, you might use this for debugging/tracing)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">      `[SERIALIZER] Message #${</span><span style=\"color:#E1E4E8\">wrapped</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">_messageId</span><span style=\"color:#9ECBFF\">} from ${</span><span style=\"color:#E1E4E8\">wrapped</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">_serializer</span><span style=\"color:#9ECBFF\">}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    );</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> wrapped.data;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Custom terminator - using double newline to avoid conflicts</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  terminator</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">\\n\\n</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Export a singleton instance for convenience</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> verboseSerializer</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> new</span><span style=\"color:#B392F0\"> VerboseJsonSerializer</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span></code></pre>"}],"renderedFiles":[]}}