{"pageId":"/pages/docs","routeParams":{"splat":"guides/middleware"},"data":{"doc":{"path":"/docs/guides/middleware","filePath":"/home/runner/work/isolated-workers/isolated-workers/docs/guides/middleware.md","title":"Middleware","description":"Intercept and transform messages with middleware pipelines","nav":{"section":"Guides","order":2}},"segments":[{"type":"html","html":"<h1>Middleware</h1>\n<p>Middleware allows you to intercept, inspect, and transform messages as they flow between host and worker. This is useful for logging, validation, timing, and adding metadata.</p>\n<h2>How Middleware Works</h2>\n<p>Middleware functions receive each message and a direction indicator (<code class=\"inline-code\">'outgoing'</code> or <code class=\"inline-code\">'incoming'</code>). They can:</p>\n<ul>\n<li><strong>Inspect</strong> messages for debugging/logging</li>\n<li><strong>Transform</strong> messages by returning modified versions (or return void to leave unchanged)</li>\n<li><strong>Validate</strong> message structure before processing</li>\n<li><strong>Track</strong> timing and performance metrics</li>\n</ul>\n<p>Middleware is applied in order, creating a pipeline where each function processes the message before passing it to the next.</p>\n<h3>Message Sealing</h3>\n<p>Messages are sealed (frozen) before being passed to middleware. You can modify existing message properties but cannot add new ones.</p>\n<h2>Creating Middleware</h2>\n<p>A middleware function has the signature:</p>"},{"type":"code-block","language":"typescript","content":"type Middleware<T> = (\n  message: AnyMessage<T>,\n  direction: 'outgoing' | 'incoming'\n) => AnyMessage<T> | void | Promise<AnyMessage<T> | void>;","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  message</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/any-message\" class=\"code-link\" title=\"View AnyMessage documentation\">AnyMessage</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">>,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  direction</span><span style=\"color:#F97583\">:</span><span style=\"color:#9ECBFF\"> 'outgoing'</span><span style=\"color:#F97583\"> |</span><span style=\"color:#9ECBFF\"> 'incoming'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/any-message\" class=\"code-link\" title=\"View AnyMessage documentation\">AnyMessage</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">|</span><span style=\"color:#79B8FF\"> void</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> Promise</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\"><a href=\"/isolated-workers/api/any-message\" class=\"code-link\" title=\"View AnyMessage documentation\">AnyMessage</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">|</span><span style=\"color:#79B8FF\"> void</span><span style=\"color:#E1E4E8\">>;</span></span></code></pre>"},{"type":"html","html":"<p>Returning void passes the original message through unchanged.</p>\n<p>Here's a logging middleware that tracks all message traffic:</p>"},{"type":"file","filename":"host.ts","language":"typescript","content":"/**\n * Logging middleware - logs all messages with direction\n */\nconst loggingMiddleware: Middleware<Messages> = (message, direction) => {\n  const arrow = direction === 'outgoing' ? '>>>' : '<<<';\n  console.log(\n    `[${direction.toUpperCase()}] ${arrow} ${message.type}`,\n    message.payload\n  );\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Logging middleware - logs all messages with direction</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> loggingMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> arrow</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> direction </span><span style=\"color:#F97583\">===</span><span style=\"color:#9ECBFF\"> 'outgoing'</span><span style=\"color:#F97583\"> ?</span><span style=\"color:#9ECBFF\"> '>>>'</span><span style=\"color:#F97583\"> :</span><span style=\"color:#9ECBFF\"> '&#x3C;&#x3C;&#x3C;'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    `[${</span><span style=\"color:#E1E4E8\">direction</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#B392F0\">toUpperCase</span><span style=\"color:#9ECBFF\">()</span><span style=\"color:#9ECBFF\">}] ${</span><span style=\"color:#E1E4E8\">arrow</span><span style=\"color:#9ECBFF\">} ${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    message.payload</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  );</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<p>You can also create middleware that tracks timing:</p>"},{"type":"file","filename":"host.ts","language":"typescript","content":"/**\n * Timing middleware - tracks how long messages take\n * Note: This is a simplified example; real timing would need request correlation\n */\nconst timingMiddleware: Middleware<Messages> = (message, direction) => {\n  if (direction === 'outgoing') {\n    console.log(`[TIMING] Request sent at: ${new Date().toISOString()}`);\n  } else {\n    console.log(`[TIMING] Response received at: ${new Date().toISOString()}`);\n  }\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Timing middleware - tracks how long messages take</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Note: This is a simplified example; real timing would need request correlation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> timingMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  if</span><span style=\"color:#E1E4E8\"> (direction </span><span style=\"color:#F97583\">===</span><span style=\"color:#9ECBFF\"> 'outgoing'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`[TIMING] Request sent at: ${</span><span style=\"color:#F97583\">new</span><span style=\"color:#B392F0\"> Date</span><span style=\"color:#9ECBFF\">().</span><span style=\"color:#B392F0\">toISOString</span><span style=\"color:#9ECBFF\">()</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  } </span><span style=\"color:#F97583\">else</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`[TIMING] Response received at: ${</span><span style=\"color:#F97583\">new</span><span style=\"color:#B392F0\"> Date</span><span style=\"color:#9ECBFF\">().</span><span style=\"color:#B392F0\">toISOString</span><span style=\"color:#9ECBFF\">()</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<h2>Using Middleware on the Host</h2>\n<p>Pass middleware to <code class=\"inline-code\"><a class=\"code-link\" href=\"/isolated-workers/isolated-workers/api/create-worker\">createWorker</a></code> as an array. Middleware executes in array order:</p>"},{"type":"file","filename":"host.ts","language":"typescript","content":"// Create worker with middleware pipeline\n  // Middleware is applied in order: logging -> timing\n  const worker = await createWorker<Messages>({\n    script: join(__dirname, 'worker.ts'),\n    timeout: 10000,\n    middleware: [loggingMiddleware, timingMiddleware],\n  });","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Create worker with middleware pipeline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Middleware is applied in order: logging -> timing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    script: </span><span style=\"color:#B392F0\">join</span><span style=\"color:#E1E4E8\">(__dirname, </span><span style=\"color:#9ECBFF\">'worker.ts'</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timeout: </span><span style=\"color:#79B8FF\">10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    middleware: [loggingMiddleware, timingMiddleware],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span></code></pre>"},{"type":"html","html":"<h2>Using Middleware on the Worker</h2>\n<p>Workers also support middleware pipelines:</p>"},{"type":"file","filename":"worker.ts","language":"typescript","content":"/**\n * Worker-side logging middleware\n */\nconst workerLoggingMiddleware: Middleware<Messages> = (message, direction) => {\n  console.log(`[WORKER ${direction}] Processing: ${message.type}`);\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">/**</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> * Worker-side logging middleware</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"> */</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> workerLoggingMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`[WORKER ${</span><span style=\"color:#E1E4E8\">direction</span><span style=\"color:#9ECBFF\">}] Processing: ${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<p>Configure it when starting the worker server:</p>"},{"type":"file","filename":"worker.ts","language":"typescript","content":"const server = await startWorkerServer(handlers, {\n    middleware: [workerLoggingMiddleware],\n  });","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> server</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\" title=\"View startWorkerServer documentation\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers, {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    middleware: [workerLoggingMiddleware],</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span></code></pre>"},{"type":"html","html":"<h2>Middleware Use Cases</h2>\n<h3>Logging and Debugging</h3>\n<p>Log all messages for debugging during development:</p>"},{"type":"code-block","language":"typescript","content":"const debugMiddleware: Middleware<Messages> = (message, direction) => {\n  console.log(\n    `[${direction}] ${message.type}:`,\n    JSON.stringify(message.payload)\n  );\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> debugMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    `[${</span><span style=\"color:#E1E4E8\">direction</span><span style=\"color:#9ECBFF\">}] ${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}:`</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    JSON</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">stringify</span><span style=\"color:#E1E4E8\">(message.payload)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  );</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<h3>Read-Only Middleware</h3>\n<p>For middleware that only inspects messages without modification, you can return void:</p>"},{"type":"code-block","language":"typescript","content":"const debugMiddleware: Middleware<Messages> = (message, direction) => {\n  console.log(\n    `[${direction}] ${message.type}:`,\n    JSON.stringify(message.payload)\n  );\n  // Returning void is equivalent to returning the original message\n  // No modification needed\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> debugMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  console.</span><span style=\"color:#B392F0\">log</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    `[${</span><span style=\"color:#E1E4E8\">direction</span><span style=\"color:#9ECBFF\">}] ${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}:`</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    JSON</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">stringify</span><span style=\"color:#E1E4E8\">(message.payload)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  );</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Returning void is equivalent to returning the original message</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // No modification needed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<p>This pattern is useful for logging, monitoring, and debugging without affecting message flow.</p>\n<h3>Validation</h3>\n<p>Validate message structure before processing:</p>"},{"type":"code-block","language":"typescript","content":"const validationMiddleware: Middleware<Messages> = (message, direction) => {\n  if (direction === 'outgoing' && !message.payload) {\n    throw new Error(`Message ${message.type} missing payload`);\n  }\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> validationMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  if</span><span style=\"color:#E1E4E8\"> (direction </span><span style=\"color:#F97583\">===</span><span style=\"color:#9ECBFF\"> 'outgoing'</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">message.payload) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    throw</span><span style=\"color:#F97583\"> new</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`Message ${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">} missing payload`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<h3>Adding Metadata</h3>\n<p>Add tracing IDs or timestamps to messages:</p>"},{"type":"code-block","language":"typescript","content":"const tracingMiddleware: Middleware<Messages> = (message, direction) => {\n  if (direction === 'outgoing') {\n    return {\n      ...message,\n      payload: {\n        ...message.payload,\n        _traceId: crypto.randomUUID(),\n      },\n    };\n  }\n  return message;\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#B392F0\"> tracingMiddleware</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/middleware\" class=\"code-link\" title=\"View Middleware documentation\">Middleware</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">direction</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  if</span><span style=\"color:#E1E4E8\"> (direction </span><span style=\"color:#F97583\">===</span><span style=\"color:#9ECBFF\"> 'outgoing'</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      ...</span><span style=\"color:#E1E4E8\">message,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      payload: {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        ...</span><span style=\"color:#E1E4E8\">message.payload,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        _traceId: crypto.</span><span style=\"color:#B392F0\">randomUUID</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> message;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<h2>Order of Execution</h2>\n<p>For <strong>outgoing</strong> messages, middleware executes in array order:</p>"},{"type":"code-block","language":"text","content":"[middleware1, middleware2, middleware3]\n     ↓           ↓           ↓\n  first       second       third","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span>[middleware1, middleware2, middleware3]</span></span>\n<span class=\"line\"><span>     ↓           ↓           ↓</span></span>\n<span class=\"line\"><span>  first       second       third</span></span></code></pre>"},{"type":"html","html":"<p>For <strong>incoming</strong> messages, the same order applies - no automatic reversal.</p>\n<h2>See Also</h2>\n<ul>\n<li>{% example-link middleware %} - Complete middleware example</li>\n<li><a href=\"/isolated-workers/docs/guides/error-handling\">Error Handling</a> - How errors propagate through the system</li>\n</ul>"}]}}