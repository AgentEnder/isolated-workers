{"pageId":"/pages/docs","routeParams":{"splat":"guides/testing"},"data":{"doc":{"path":"/docs/guides/testing","filePath":"/home/runner/work/isolated-workers/isolated-workers/docs/guides/testing.md","title":"Testing Workers","description":"Strategies for testing worker-based code","nav":{"section":"Guides","order":8}},"segments":[{"type":"html","html":"<h1>Testing Workers</h1>\n<p>Testing worker-based code requires different strategies depending on what you want to verify. This guide covers unit testing handlers in isolation, integration testing with real workers, and patterns for mocking workers in host-side tests.</p>\n<h2>Testing Strategies Overview</h2>\n<p>Worker-based applications have three natural testing layers:</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<table><thead><tr><th>Layer</th><th>What to Test</th><th>Speed</th><th>Isolation</th></tr></thead><tbody><tr><td><strong>Unit</strong></td><td>Handler logic, message validation</td><td>Fast</td><td>High</td></tr><tr><td><strong>Integration</strong></td><td>Full IPC round-trips, serialization</td><td>Medium</td><td>Medium</td></tr><tr><td><strong>E2E</strong></td><td>Complete workflows, process lifecycle</td><td>Slow</td><td>Low</td></tr></tbody></table>\n<h3>When to Use Each Strategy</h3>\n<ul>\n<li><strong>Unit tests</strong>: Business logic in handlers, validation, transformations</li>\n<li><strong>Integration tests</strong>: IPC communication, serialization, timeouts, error propagation</li>\n<li><strong>E2E tests</strong>: Full application workflows, deployment verification</li>\n</ul>\n<h2>Testing Handlers in Isolation</h2>\n<p>The fastest and most reliable tests focus on handler functions directly, without spawning worker processes.</p>\n<h3>Extract Handler Logic</h3>\n<p>Structure your workers to make handlers easily testable:</p>"},{"type":"code-block","language":"typescript","content":"// handlers.ts - Testable handler logic\nimport type { Handlers } from 'isolated-workers';\nimport type { Messages } from './messages.js';\n\nexport function createHandlers(deps: { db: Database }): Handlers<Messages> {\n  return {\n    getUser: async ({ userId }) => {\n      const user = await deps.db.findUser(userId);\n      if (!user) {\n        throw new Error(`User ${userId} not found`);\n      }\n      return { user };\n    },\n\n    createUser: async ({ name, email }) => {\n      const id = await deps.db.createUser({ name, email });\n      return { id };\n    },\n  };\n}","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handlers.ts - Testable handler logic</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/handlers\" class=\"code-link\" title=\"View Handlers documentation\">Handlers</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#F97583\"> type</span><span style=\"color:#E1E4E8\"> { Messages } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './messages.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> function</span><span style=\"color:#B392F0\"> createHandlers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">deps</span><span style=\"color:#F97583\">:</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#FFAB70\">db</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> Database</span><span style=\"color:#E1E4E8\"> })</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/handlers\" class=\"code-link\" title=\"View Handlers documentation\">Handlers</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    getUser</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> ({ </span><span style=\"color:#FFAB70\">userId</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> user</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> deps.db.</span><span style=\"color:#B392F0\">findUser</span><span style=\"color:#E1E4E8\">(userId);</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      if</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#F97583\">!</span><span style=\"color:#E1E4E8\">user) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        throw</span><span style=\"color:#F97583\"> new</span><span style=\"color:#B392F0\"> Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`User ${</span><span style=\"color:#E1E4E8\">userId</span><span style=\"color:#9ECBFF\">} not found`</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      return</span><span style=\"color:#E1E4E8\"> { user };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    createUser</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> ({ </span><span style=\"color:#FFAB70\">name</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> id</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> deps.db.</span><span style=\"color:#B392F0\">createUser</span><span style=\"color:#E1E4E8\">({ name, email });</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      return</span><span style=\"color:#E1E4E8\"> { id };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre>"},{"type":"code-block","language":"typescript","content":"// worker.ts - Thin wrapper that starts the server\nimport { startWorkerServer } from 'isolated-workers';\nimport { createHandlers } from './handlers.js';\nimport { createDatabase } from './database.js';\n\nconst db = createDatabase();\nconst handlers = createHandlers({ db });\n\nstartWorkerServer(handlers);","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// worker.ts - Thin wrapper that starts the server</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { <a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\" title=\"View startWorkerServer documentation\">startWorkerServer</a> } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> 'isolated-workers'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { createHandlers } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './handlers.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { createDatabase } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './database.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> db</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> createDatabase</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> createHandlers</span><span style=\"color:#E1E4E8\">({ db });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\"><a href=\"/isolated-workers/api/start-worker-server\" class=\"code-link\" title=\"View startWorkerServer documentation\">startWorkerServer</a></span><span style=\"color:#E1E4E8\">(handlers);</span></span></code></pre>"},{"type":"html","html":"<h3>Unit Testing Handlers</h3>\n<p>Test handlers as regular async functions:</p>"},{"type":"code-block","language":"typescript","content":"// handlers.spec.ts\nimport { createHandlers } from './handlers.js';\n\ndescribe('User Handlers', () => {\n  const mockDb = {\n    findUser: jest.fn(),\n    createUser: jest.fn(),\n  };\n\n  const handlers = createHandlers({ db: mockDb });\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('getUser', () => {\n    it('returns user when found', async () => {\n      const user = { id: '123', name: 'Alice' };\n      mockDb.findUser.mockResolvedValue(user);\n\n      const result = await handlers.getUser({ userId: '123' });\n\n      expect(result).toEqual({ user });\n      expect(mockDb.findUser).toHaveBeenCalledWith('123');\n    });\n\n    it('throws when user not found', async () => {\n      mockDb.findUser.mockResolvedValue(null);\n\n      await expect(handlers.getUser({ userId: 'unknown' })).rejects.toThrow(\n        'User unknown not found'\n      );\n  });\n});\n  ","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handlers.spec.ts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { createHandlers } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './handlers.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'User Handlers'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> mockDb</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    findUser: jest.</span><span style=\"color:#B392F0\">fn</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    createUser: jest.</span><span style=\"color:#B392F0\">fn</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">  const</span><span style=\"color:#79B8FF\"> handlers</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> createHandlers</span><span style=\"color:#E1E4E8\">({ db: mockDb });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  beforeEach</span><span style=\"color:#E1E4E8\">(() </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    jest.</span><span style=\"color:#B392F0\">clearAllMocks</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'getUser'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'returns user when found'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> user</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> { id: </span><span style=\"color:#9ECBFF\">'123'</span><span style=\"color:#E1E4E8\">, name: </span><span style=\"color:#9ECBFF\">'Alice'</span><span style=\"color:#E1E4E8\"> };</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      mockDb.findUser.</span><span style=\"color:#B392F0\">mockResolvedValue</span><span style=\"color:#E1E4E8\">(user);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> handlers.</span><span style=\"color:#B392F0\">getUser</span><span style=\"color:#E1E4E8\">({ userId: </span><span style=\"color:#9ECBFF\">'123'</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(result).</span><span style=\"color:#B392F0\">toEqual</span><span style=\"color:#E1E4E8\">({ user });</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(mockDb.findUser).</span><span style=\"color:#B392F0\">toHaveBeenCalledWith</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'123'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'throws when user not found'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      mockDb.findUser.</span><span style=\"color:#B392F0\">mockResolvedValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">null</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#B392F0\"> expect</span><span style=\"color:#E1E4E8\">(handlers.</span><span style=\"color:#B392F0\">getUser</span><span style=\"color:#E1E4E8\">({ userId: </span><span style=\"color:#9ECBFF\">'unknown'</span><span style=\"color:#E1E4E8\"> })).rejects.</span><span style=\"color:#B392F0\">toThrow</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        'User unknown not found'</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      );</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  </span></span></code></pre>"},{"type":"html","html":"<h2>Test File Organization</h2>\n<p>Organize your test files by layer to maintain clarity and enable selective test execution:</p>"},{"type":"code-block","language":"markdown","content":"src/\n├── handlers/\n│ └── calculator.spec.ts # Unit tests - handler logic only\n├── worker.ts\n└── worker.integration.spec.ts # Integration tests - full IPC round-trips\ntests/\n├── e2e/\n│ └── workflow.spec.ts # E2E tests - complete application flows\n└── test-utils/\n├── mock-worker.ts\n└── ci-config.ts","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">src/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">├── handlers/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">│ └── calculator.spec.ts # Unit tests - handler logic only</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">├── worker.ts</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">└── worker.integration.spec.ts # Integration tests - full IPC round-trips</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">tests/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">├── e2e/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">│ └── workflow.spec.ts # E2E tests - complete application flows</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">└── test-utils/</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">├── mock-worker.ts</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">└── ci-config.ts</span></span></code></pre>"},{"type":"html","html":"<p><strong>Naming Conventions</strong>:</p>\n<ul>\n<li><code class=\"inline-code\">*.spec.ts</code> or <code class=\"inline-code\">*.test.ts</code> - Unit tests for individual functions/modules</li>\n<li><code class=\"inline-code\">*.integration.spec.ts</code> - Integration tests with real workers and IPC</li>\n<li><code class=\"inline-code\">e2e/*.spec.ts</code> - End-to-end tests of complete workflows</li>\n</ul>\n<p><strong>Package.json Scripts</strong>:</p>"},{"type":"code-block","language":"json","content":"{\n  \"scripts\": {\n    \"test\": \"jest\",\n    \"test:unit\": \"jest --testPathIgnorePatterns='integration'\",\n    \"test:integration\": \"jest --testPathPattern='integration'\",\n    \"test:e2e\": \"jest --config=jest.e2e.config.js\"\n  }\n}","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  \"scripts\"</span><span style=\"color:#E1E4E8\">: {</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    \"test\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"jest\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    \"test:unit\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"jest --testPathIgnorePatterns='integration'\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    \"test:integration\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"jest --testPathPattern='integration'\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    \"test:e2e\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"jest --config=jest.e2e.config.js\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre>"},{"type":"html","html":"<p>This organization allows:</p>\n<ul>\n<li>Fast feedback from unit tests during development</li>\n<li>Separate integration test runs when needed</li>\n<li>E2E tests only during CI/CD or before releases</li>\n<li>Clear separation of concerns in test suites</li>\n</ul>\n<h2>Async Testing Patterns</h2>\n<h3>Handling Timeouts</h3>\n<p>Test timeout behavior explicitly:</p>"},{"type":"code-block","language":"typescript","content":"describe('Timeout Handling', () => {\n  it('times out slow operations', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n      timeout: {\n        WORKER_MESSAGE: 100, // Very short timeout for testing\n      },\n    });\n\n    try {\n      await expect(worker.send('slowOperation', {})).rejects.toThrow(\n        /timeout/i\n      );\n    } finally {\n      await worker.close();\n    }\n  });\n\n  it('completes within timeout', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n      timeout: {\n        fastOperation: 5000,\n      },\n    });\n\n    try {\n      const result = await worker.send('fastOperation', {});\n      expect(result).toBeDefined();\n    } finally {\n      await worker.close();\n    }\n  });\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Timeout Handling'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'times out slow operations'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      timeout: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        WORKER_MESSAGE: </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// Very short timeout for testing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#B392F0\"> expect</span><span style=\"color:#E1E4E8\">(worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'slowOperation'</span><span style=\"color:#E1E4E8\">, {})).rejects.</span><span style=\"color:#B392F0\">toThrow</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        /</span><span style=\"color:#DBEDFF\">timeout</span><span style=\"color:#9ECBFF\">/</span><span style=\"color:#F97583\">i</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      );</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'completes within timeout'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      timeout: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fastOperation: </span><span style=\"color:#79B8FF\">5000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'fastOperation'</span><span style=\"color:#E1E4E8\">, {});</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(result).</span><span style=\"color:#B392F0\">toBeDefined</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h3>Proper Cleanup with finally</h3>\n<p>Always clean up workers, even when tests fail:</p>"},{"type":"code-block","language":"typescript","content":"describe('Resource Cleanup', () => {\n  it('cleans up on success', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n    });\n\n    try {\n      const result = await worker.send('compute', { data: 42 });\n      expect(result.value).toBe(84);\n    } finally {\n      await worker.close();\n      expect(worker.isActive).toBe(false);\n    }\n  });\n\n  it('cleans up on failure', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n    });\n\n    try {\n      await worker.send('fail', {});\n    } catch {\n      // Expected error\n    } finally {\n      await worker.close();\n      expect(worker.isActive).toBe(false);\n    }\n  });\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Resource Cleanup'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'cleans up on success'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> result</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'compute'</span><span style=\"color:#E1E4E8\">, { data: </span><span style=\"color:#79B8FF\">42</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(result.value).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">84</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(worker.isActive).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'cleans up on failure'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    try</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'fail'</span><span style=\"color:#E1E4E8\">, {});</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">catch</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">      // Expected error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    } </span><span style=\"color:#F97583\">finally</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(worker.isActive).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h3>Testing Worker Lifecycle Events</h3>"},{"type":"code-block","language":"typescript","content":"describe('Lifecycle Events', () => {\n  it('detects worker shutdown', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n    });\n\n    expect(worker.isActive).toBe(true);\n    expect(worker.isConnected).toBe(true);\n\n    await worker.close();\n\n    expect(worker.isActive).toBe(false);\n    expect(worker.isConnected).toBe(false);\n  });\n\n  it('rejects messages after close', async () => {\n    const worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n    });\n\n    await worker.close();\n\n    await expect(worker.send('ping', {})).rejects.toThrow(/not active/i);\n  });\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Lifecycle Events'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'detects worker shutdown'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(worker.isActive).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(worker.isConnected).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(worker.isActive).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(worker.isConnected).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'rejects messages after close'</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#E1E4E8\"> worker.</span><span style=\"color:#B392F0\">close</span><span style=\"color:#E1E4E8\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">    await</span><span style=\"color:#B392F0\"> expect</span><span style=\"color:#E1E4E8\">(worker.</span><span style=\"color:#B392F0\">send</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'ping'</span><span style=\"color:#E1E4E8\">, {})).rejects.</span><span style=\"color:#B392F0\">toThrow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">/</span><span style=\"color:#DBEDFF\">not active</span><span style=\"color:#9ECBFF\">/</span><span style=\"color:#F97583\">i</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h2>CI Considerations</h2>\n<h3>GitHub Actions Example</h3>"},{"type":"code-block","language":"yaml","content":"# .github/workflows/test.yml\nname: Tests\n\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n\n      - name: Install dependencies\n        run: npm ci\n\n      - name: Build worker scripts\n        run: npm run build\n\n      - name: Run unit tests\n        run: npm test -- --testPathPattern='\\\\.spec\\\\.ts$'\n\n      - name: Run integration tests\n        run: npm test -- --testPathPattern='\\\\.integration\\\\.ts$'\n        timeout-minutes: 10","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\"># .github/workflows/test.yml</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Tests</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">on</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">push</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">pull_request</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#85E89D\">jobs</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  test</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    runs-on</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">ubuntu-latest</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    steps</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">uses</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">actions/checkout@v4</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Setup Node.js</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        uses</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">actions/setup-node@v4</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        with</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">          node-version</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">'20'</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Install dependencies</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        run</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">npm ci</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Build worker scripts</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        run</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">npm run build</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Run unit tests</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        run</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">npm test -- --testPathPattern='\\\\.spec\\\\.ts$'</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#85E89D\">name</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Run integration tests</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        run</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">npm test -- --testPathPattern='\\\\.integration\\\\.ts$'</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        timeout-minutes</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span></code></pre>"},{"type":"html","html":"<h3>CI-Specific Timeout Adjustments</h3>\n<p>CI environments are often slower than local machines:</p>"},{"type":"code-block","language":"typescript","content":"// test-utils/ci-config.ts\nexport const isCI = process.env.CI === 'true';\n\nexport const timeouts = {\n  workerStartup: isCI ? 20000 : 10000,\n  workerMessage: isCI ? 30000 : 10000,\n  testTimeout: isCI ? 60000 : 30000,\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// test-utils/ci-config.ts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> isCI</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> process.env.</span><span style=\"color:#79B8FF\">CI</span><span style=\"color:#F97583\"> ===</span><span style=\"color:#9ECBFF\"> 'true'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> const</span><span style=\"color:#79B8FF\"> timeouts</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  workerStartup: isCI </span><span style=\"color:#F97583\">?</span><span style=\"color:#79B8FF\"> 20000</span><span style=\"color:#F97583\"> :</span><span style=\"color:#79B8FF\"> 10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  workerMessage: isCI </span><span style=\"color:#F97583\">?</span><span style=\"color:#79B8FF\"> 30000</span><span style=\"color:#F97583\"> :</span><span style=\"color:#79B8FF\"> 10000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  testTimeout: isCI </span><span style=\"color:#F97583\">?</span><span style=\"color:#79B8FF\"> 60000</span><span style=\"color:#F97583\"> :</span><span style=\"color:#79B8FF\"> 30000</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"code-block","language":"typescript","content":"// integration.spec.ts\nimport { timeouts } from './test-utils/ci-config.js';\n\ndescribe('Integration Tests', () => {\n  let worker: WorkerClient<Messages>;\n\n  beforeAll(async () => {\n    worker = await createWorker<Messages>({\n      script: './dist/worker.js',\n      timeout: {\n        WORKER_STARTUP: timeouts.workerStartup,\n        WORKER_MESSAGE: timeouts.workerMessage,\n      },\n    });\n  }, timeouts.testTimeout);\n\n  // ...tests\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// integration.spec.ts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { timeouts } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './test-utils/ci-config.js'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Integration Tests'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  let</span><span style=\"color:#E1E4E8\"> worker</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/worker-client\" class=\"code-link\" title=\"View WorkerClient documentation\">WorkerClient</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  beforeAll</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">async</span><span style=\"color:#E1E4E8\"> () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    worker </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      timeout: {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        WORKER_STARTUP: timeouts.workerStartup,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        WORKER_MESSAGE: timeouts.workerMessage,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  }, timeouts.testTimeout);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // ...tests</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h3>Avoiding Port/Socket Conflicts</h3>\n<p>Run integration tests sequentially to avoid socket conflicts:</p>"},{"type":"code-block","language":"javascript","content":"// jest.config.js\nmodule.exports = {\n  // Run test files sequentially\n  maxWorkers: 1,\n\n  // Or use runInBand for complete isolation\n  // runInBand: true,\n};","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// jest.config.js</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">module</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#79B8FF\">exports</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Run test files sequentially</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  maxWorkers: </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // Or use runInBand for complete isolation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  // runInBand: true,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span></code></pre>"},{"type":"html","html":"<h3>Debugging Failed CI Tests</h3>\n<p>Enable debug logging in CI for troubleshooting:</p>"},{"type":"code-block","language":"typescript","content":"const worker = await createWorker<Messages>({\n  script: './dist/worker.js',\n  logLevel: process.env.CI ? 'debug' : 'error',\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> worker</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> await</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/create-worker\" class=\"code-link\" title=\"View createWorker documentation\">createWorker</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">>({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  script: </span><span style=\"color:#9ECBFF\">'./dist/worker.js'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  logLevel: process.env.</span><span style=\"color:#79B8FF\">CI</span><span style=\"color:#F97583\"> ?</span><span style=\"color:#9ECBFF\"> 'debug'</span><span style=\"color:#F97583\"> :</span><span style=\"color:#9ECBFF\"> 'error'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h2>Best Practices Summary</h2>\n<ol>\n<li><strong>Unit test handlers directly</strong> - Extract handler logic into testable functions</li>\n<li><strong>Use dependency injection</strong> - Pass dependencies to handlers for easy mocking</li>\n<li><strong>Mock workers for host tests</strong> - Avoid process overhead when testing host code</li>\n<li><strong>Clean up workers in finally blocks</strong> - Prevent orphaned processes</li>\n<li><strong>Adjust timeouts for CI</strong> - CI environments are slower than local machines</li>\n<li><strong>Run integration tests sequentially</strong> - Avoid socket conflicts</li>\n<li><strong>Separate unit and integration tests</strong> - Run fast tests frequently, slow tests less often</li>\n</ol>\n<h3>Custom Transaction ID Generator Testing</h3>\n<p>When testing code that uses custom transaction ID generators, ensure your generator produces unique IDs:</p>"},{"type":"code-block","language":"typescript","content":"// custom-tx-generator.ts\nexport const customTxIdGenerator: TransactionIdGenerator<Messages> = (\n  message\n) => {\n  return `${message.type}-${Date.now()}-${Math.random()\n    .toString(36)\n    .substr(2, 9)}`;\n};\n\n// custom-tx-generator.spec.ts\nimport { customTxIdGenerator } from './custom-tx-generator';\n\ndescribe('Custom Transaction ID Generator', () => {\n  it('generates unique IDs for different calls', () => {\n    const id1 = customTxIdGenerator({ type: 'test', payload: {}, tx: 'init' });\n    const id2 = customTxIdGenerator({ type: 'test', payload: {}, tx: 'init' });\n\n    expect(id1).not.toBe(id2);\n  });\n\n  it('includes message type in ID', () => {\n    const id = customTxIdGenerator({\n      type: 'processImage',\n      payload: {},\n      tx: 'init',\n    });\n    expect(id).toContain('processImage');\n  });\n\n  it('generates IDs compatible with transaction tracking', () => {\n    const ids = new Set<string>();\n    for (let i = 0; i < 1000; i++) {\n      const id = customTxIdGenerator({ type: 'test', payload: {}, tx: 'init' });\n      expect(ids.has(id)).toBe(false);\n      ids.add(id);\n    }\n  });\n});","highlightedHtml":"<pre class=\"shiki github-dark\" style=\"background-color:#00000000;color:#e1e4e8\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#6A737D\">// custom-tx-generator.ts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">export</span><span style=\"color:#F97583\"> const</span><span style=\"color:#B392F0\"> customTxIdGenerator</span><span style=\"color:#F97583\">:</span><span style=\"color:#B392F0\"> <a href=\"/isolated-workers/api/transaction-id-generator\" class=\"code-link\" title=\"View TransactionIdGenerator documentation\">TransactionIdGenerator</a></span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#B392F0\">Messages</span><span style=\"color:#E1E4E8\">> </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">  message</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  return</span><span style=\"color:#9ECBFF\"> `${</span><span style=\"color:#E1E4E8\">message</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#E1E4E8\">type</span><span style=\"color:#9ECBFF\">}-${</span><span style=\"color:#E1E4E8\">Date</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#B392F0\">now</span><span style=\"color:#9ECBFF\">()</span><span style=\"color:#9ECBFF\">}-${</span><span style=\"color:#E1E4E8\">Math</span><span style=\"color:#9ECBFF\">.</span><span style=\"color:#B392F0\">random</span><span style=\"color:#9ECBFF\">()</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    .</span><span style=\"color:#B392F0\">toString</span><span style=\"color:#9ECBFF\">(</span><span style=\"color:#79B8FF\">36</span><span style=\"color:#9ECBFF\">)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    .</span><span style=\"color:#B392F0\">substr</span><span style=\"color:#9ECBFF\">(</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">9</span><span style=\"color:#9ECBFF\">)</span><span style=\"color:#9ECBFF\">}`</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// custom-tx-generator.spec.ts</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> { customTxIdGenerator } </span><span style=\"color:#F97583\">from</span><span style=\"color:#9ECBFF\"> './custom-tx-generator'</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">describe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'Custom Transaction ID Generator'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'generates unique IDs for different calls'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> id1</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> customTxIdGenerator</span><span style=\"color:#E1E4E8\">({ type: </span><span style=\"color:#9ECBFF\">'test'</span><span style=\"color:#E1E4E8\">, payload: {}, tx: </span><span style=\"color:#9ECBFF\">'init'</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> id2</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> customTxIdGenerator</span><span style=\"color:#E1E4E8\">({ type: </span><span style=\"color:#9ECBFF\">'test'</span><span style=\"color:#E1E4E8\">, payload: {}, tx: </span><span style=\"color:#9ECBFF\">'init'</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(id1).not.</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(id2);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'includes message type in ID'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> id</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> customTxIdGenerator</span><span style=\"color:#E1E4E8\">({</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      type: </span><span style=\"color:#9ECBFF\">'processImage'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      payload: {},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      tx: </span><span style=\"color:#9ECBFF\">'init'</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    });</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    expect</span><span style=\"color:#E1E4E8\">(id).</span><span style=\"color:#B392F0\">toContain</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'processImage'</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  it</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">'generates IDs compatible with transaction tracking'</span><span style=\"color:#E1E4E8\">, () </span><span style=\"color:#F97583\">=></span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    const</span><span style=\"color:#79B8FF\"> ids</span><span style=\"color:#F97583\"> =</span><span style=\"color:#F97583\"> new</span><span style=\"color:#B392F0\"> Set</span><span style=\"color:#E1E4E8\">&#x3C;</span><span style=\"color:#79B8FF\">string</span><span style=\"color:#E1E4E8\">>();</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#F97583\">let</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 1000</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">      const</span><span style=\"color:#79B8FF\"> id</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> customTxIdGenerator</span><span style=\"color:#E1E4E8\">({ type: </span><span style=\"color:#9ECBFF\">'test'</span><span style=\"color:#E1E4E8\">, payload: {}, tx: </span><span style=\"color:#9ECBFF\">'init'</span><span style=\"color:#E1E4E8\"> });</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">      expect</span><span style=\"color:#E1E4E8\">(ids.</span><span style=\"color:#B392F0\">has</span><span style=\"color:#E1E4E8\">(id)).</span><span style=\"color:#B392F0\">toBe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      ids.</span><span style=\"color:#B392F0\">add</span><span style=\"color:#E1E4E8\">(id);</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  });</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">});</span></span></code></pre>"},{"type":"html","html":"<h3>Mock Worker Limitations</h3>\n<p>When using mock workers for testing, be aware that:</p>\n<ul>\n<li><strong>Mock workers bypass driver capability constraints</strong> - They don't enforce driver-specific features or limitations</li>\n<li>No actual serialization/deserialization occurs</li>\n<li>Network/IO latency is not simulated</li>\n<li>Real process lifecycle events are not tested</li>\n<li>Socket/file cleanup is not verified</li>\n</ul>\n<p>Use real workers in integration tests to verify driver-specific behavior, especially when:</p>\n<ul>\n<li>Testing serialization formats or custom serializers</li>\n<li>Verifying timeout handling across process boundaries</li>\n<li>Validating error propagation through actual IPC</li>\n<li>Testing resource limits or worker crashes</li>\n</ul>\n<h2>See Also</h2>\n<ul>\n<li><a href=\"/isolated-workers/docs/guides/error-handling\">Error Handling</a> - Testing error propagation</li>\n<li><a href=\"/isolated-workers/docs/guides/worker-lifecycle\">Worker Lifecycle</a> - Testing lifecycle events</li>\n<li><a href=\"/isolated-workers/docs/guides/timeout-configuration\">Timeout Configuration</a> - Configuring test timeouts</li>\n</ul>"}]}}